<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sudoku Pro</title>
    <style>
        :root {
            --bg: #ffffff;
            --text: #333333;
            --grid-border: #344861;
            --cell-border: #bfc6d4;
            --cell-bg: #ffffff;
            --cell-bg-selected: #bbdefb;
            --cell-bg-highlight: #e2ebf3;
            --cell-bg-same: #cbe4f9;
            --text-blue: #007bff;
            --text-error: #dc3545;
            --cell-bg-error: #fccacf;
            --note-color: #666;
            --btn-bg: #f0f0f0;
            --btn-active: #333;
            --btn-active-text: #fff;
            --btn-completed: #e0e0e0;
            --btn-completed-text: #a0a0a0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #121213;
                --text: #e0e0e0;
                --grid-border: #888;
                --cell-border: #3a3a3c;
                --cell-bg: #121213;
                --cell-bg-selected: #004a77;
                --cell-bg-highlight: #2c3032;
                --cell-bg-same: #1e3a5f;
                --text-blue: #4dabf7;
                --text-error: #ff6b6b;
                --cell-bg-error: #5c2b2f;
                --note-color: #a0a0a0;
                --btn-bg: #2c2c2e;
                --btn-active: #e0e0e0;
                --btn-active-text: #000;
                --btn-completed: #1f1f20;
                --btn-completed-text: #555;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* é¡¶éƒ¨æ  */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 95%;
            max-width: 500px;
            padding: 10px 0;
            border-bottom: 1px solid var(--cell-border);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .status-bar { display: flex; gap: 15px; align-items: center; font-weight: 500; }
        .mistakes { color: var(--text-error); }

        select {
            padding: 4px 8px;
            border-radius: 5px;
            background: var(--btn-bg);
            color: var(--text);
            border: 1px solid var(--cell-border);
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            background-color: var(--btn-bg);
            color: var(--text);
            transition: all 0.1s;
        }
        button:hover { filter: brightness(0.9); }
        button.active { background-color: var(--btn-active); color: var(--btn-active-text); }

        /* æ•°ç‹¬æ£‹ç›˜ */
        #game-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 95vw;
            height: 95vw;
            max-width: 450px;
            max-height: 450px;
            border: 2px solid var(--grid-border);
            box-sizing: border-box;
            background: var(--grid-border);
            gap: 1px; /* ä½¿ç”¨ gap æ¥æ¨¡æ‹Ÿè¾¹æ¡†ï¼Œæ›´é”åˆ© */
        }

        .cell {
            background-color: var(--cell-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            position: relative;
            cursor: pointer;
        }

        /* 3x3 ç²—çº¿æ¡ï¼šé€šè¿‡ gap å·²ç»æœ‰äº†åŸºç¡€åˆ†å‰²ï¼Œè¿™é‡ŒåŠ å¼ºå®«æ ¼è¾¹ç•Œ */
        .cell:nth-child(3n) { border-right: 2px solid var(--grid-border); }
        .cell:nth-child(9n) { border-right: none; }
        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid var(--grid-border); }

        /* çŠ¶æ€æ ·å¼ */
        .cell.selected { background-color: var(--cell-bg-selected) !important; }
        .cell.highlight { background-color: var(--cell-bg-highlight); }
        .cell.same-number { background-color: var(--cell-bg-same); }
        .cell.fixed { font-weight: bold; color: var(--text); }
        .cell.user-input { color: var(--text-blue); }
        .cell.error { background-color: var(--cell-bg-error); color: var(--text-error); animation: shake 0.3s; }

        /* ç¬”è®°æ ·å¼ */
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .note-num {
            font-size: 0.65rem;
            color: var(--note-color);
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }

        /* åº•éƒ¨é”®ç›˜ */
        #numpad {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5åˆ— */
            gap: 8px;
            width: 95%;
            max-width: 500px;
            margin-top: 15px;
        }

        .num-btn {
            height: 48px;
            font-size: 1.3rem;
            border-radius: 8px;
            background-color: var(--btn-bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        /* æ•°å­—å·²å®ŒæˆçŠ¶æ€ */
        .num-btn.completed {
            background-color: var(--btn-completed);
            color: var(--btn-completed-text);
            pointer-events: none; /* ç¦æ­¢ç‚¹å‡» */
        }
        
        /* å·¥å…·æ  */
        .tools {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            width: 95%;
            max-width: 500px;
            justify-content: space-between;
        }
        
        .tool-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.75rem;
            padding: 8px 0;
            background: transparent;
        }
        .tool-icon { font-size: 1.2rem; margin-bottom: 2px;}

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }
        
        /* èƒœåˆ©åŠ¨ç”»è¦†ç›–å±‚ */
        #win-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        #win-overlay.show { opacity: 1; pointer-events: all; }
        #win-overlay h1 { font-size: 3rem; margin-bottom: 10px; }
        .win-btn { background: var(--text-blue); color: white; font-size: 1.2rem; padding: 10px 30px; margin-top: 20px;}

        @media (max-height: 700px) {
            header { margin-bottom: 5px; padding: 5px 0; }
            #game-board { max-width: 360px; max-height: 360px; }
            #numpad { margin-top: 10px; }
            .num-btn { height: 40px; }
        }
    </style>
</head>
<body>

<header>
    <select id="difficulty">
        <option value="30">ç®€å•</option>
        <option value="40" selected>ä¸­ç­‰</option>
        <option value="50">å›°éš¾</option>
        <option value="60">åœ°ç‹±</option>
    </select>
    
    <div class="status-bar">
        <span class="mistakes">é”™è¯¯: <span id="mistake-count">0</span>/3</span>
        <span id="timer">00:00</span>
    </div>
    
    <button onclick="newGame()">æ–°å±€</button>
</header>

<div id="game-board"></div>

<div class="tools">
    <button class="tool-btn" onclick="undo()">
        <span class="tool-icon">â†©</span> æ’¤é”€
    </button>
    <button class="tool-btn" onclick="erase()">
        <span class="tool-icon">âŒ«</span> æ“¦é™¤
    </button>
    <button class="tool-btn" id="btn-note" onclick="toggleNoteMode()">
        <span class="tool-icon">âœ</span> <span id="note-text">ç¬”è®°: å…³</span>
    </button>
    <button class="tool-btn" onclick="checkHint()">
        <span class="tool-icon">ğŸ’¡</span> æç¤º
    </button>
</div>

<div id="numpad">
    </div>

<div id="win-overlay">
    <h1>ğŸ‰ å®Œç¾!</h1>
    <p>ç”¨æ—¶: <span id="final-time"></span></p>
    <p>é”™è¯¯: <span id="final-mistakes"></span></p>
    <button class="win-btn" onclick="closeWinOverlay()">å†æ¥ä¸€å±€</button>
</div>

<script>
    // --- æ¸¸æˆçŠ¶æ€ ---
    let board = [];        // å½“å‰ç›˜é¢
    let solution = [];     // å®Œæ•´ç­”æ¡ˆ (ç”¨äºå®æ—¶åˆ¤é”™)
    let initialBoard = []; // åˆå§‹ç›˜é¢
    let notes = [];        // ç¬”è®°
    let history = [];      // å†å²è®°å½•
    
    let selectedCell = null;
    let isNoteMode = false;
    let timerInterval;
    let timeSeconds = 0;
    let mistakes = 0;
    let isGameOver = false;

    // --- åˆå§‹åŒ– ---
    const boardEl = document.getElementById('game-board');
    const numpadEl = document.getElementById('numpad');

    function initUI() {
        // ç”Ÿæˆæ£‹ç›˜æ ¼å­
        boardEl.innerHTML = '';
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${r}-${c}`;
                cell.onclick = () => selectCell(r, c);
                
                const noteGrid = document.createElement('div');
                noteGrid.className = 'notes-grid';
                for(let i=1; i<=9; i++) {
                    const n = document.createElement('div');
                    n.className = 'note-num';
                    n.id = `note-${r}-${c}-${i}`;
                    noteGrid.appendChild(n);
                }
                cell.appendChild(noteGrid);
                boardEl.appendChild(cell);
            }
        }
        // ç”Ÿæˆæ•°å­—é”®ç›˜
        numpadEl.innerHTML = '';
        for(let i=1; i<=9; i++) {
            const btn = document.createElement('button');
            btn.className = 'num-btn';
            btn.textContent = i;
            btn.id = `btn-num-${i}`;
            btn.onclick = () => inputNumber(i);
            numpadEl.appendChild(btn);
        }
    }

    function newGame() {
        const diff = parseInt(document.getElementById('difficulty').value);
        generateSudoku(diff);
        
        notes = Array(9).fill(null).map(() => Array(9).fill(null).map(() => new Set()));
        history = [];
        timeSeconds = 0;
        mistakes = 0;
        isGameOver = false;
        selectedCell = null;
        
        document.getElementById('mistake-count').textContent = 0;
        document.getElementById('win-overlay').classList.remove('show');
        
        clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
        
        renderBoard();
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    function generateSudoku(holes) {
        solution = Array(9).fill(null).map(() => Array(9).fill(0));
        fillDiagonal();
        solveSudoku(solution);
        
        board = JSON.parse(JSON.stringify(solution));
        initialBoard = Array(9).fill(null).map(() => Array(9).fill(0));
        
        let attempts = holes;
        while (attempts > 0) {
            let r = Math.floor(Math.random() * 9);
            let c = Math.floor(Math.random() * 9);
            if (board[r][c] !== 0) {
                board[r][c] = 0;
                attempts--;
            }
        }
        
        for(let r=0; r<9; r++) {
            for(let c=0; c<9; c++) {
                if(board[r][c] !== 0) initialBoard[r][c] = board[r][c];
            }
        }
    }

    // (è¿™é‡Œå¤ç”¨ä¹‹å‰é«˜æ•ˆçš„æ•°ç‹¬ç”Ÿæˆç®—æ³•ï¼Œç¯‡å¹…åŸå› çœç•¥é‡å¤ä»£ç ï¼Œé€»è¾‘ä¿æŒä¸€è‡´)
    function fillDiagonal() { for (let i = 0; i < 9; i+=3) fillBox(i, i); }
    function fillBox(row, col) {
        let num;
        for (let i=0; i<3; i++) {
            for (let j=0; j<3; j++) {
                do { num = Math.floor(Math.random() * 9) + 1; } while (!isSafeBox(row, col, num));
                solution[row+i][col+j] = num;
            }
        }
    }
    function isSafeBox(rowStart, colStart, num) {
        for (let i=0; i<3; i++) for (let j=0; j<3; j++) if (solution[rowStart+i][colStart+j] === num) return false;
        return true;
    }
    function solveSudoku(grid) {
        for (let r=0; r<9; r++) {
            for (let c=0; c<9; c++) {
                if (grid[r][c] === 0) {
                    for (let num=1; num<=9; num++) {
                        if (isValid(grid, r, c, num)) {
                            grid[r][c] = num;
                            if (solveSudoku(grid)) return true;
                            grid[r][c] = 0;
                        }
                    }
                    return false;
                }
            }
        }
        return true;
    }
    function isValid(grid, row, col, num) {
        for (let x=0; x<9; x++) if (grid[row][x] === num) return false;
        for (let x=0; x<9; x++) if (grid[x][col] === num) return false;
        let startRow = row - row % 3, startCol = col - col % 3;
        for (let i=0; i<3; i++) for (let j=0; j<3; j++) if (grid[i+startRow][j+startCol] === num) return false;
        return true;
    }

    // --- äº¤äº’é€»è¾‘ (å‡çº§ç‰ˆ) ---
    function selectCell(r, c) {
        if(isGameOver) return;
        selectedCell = {r, c};
        highlightBoard();
    }

    function inputNumber(num) {
        if (isGameOver || !selectedCell) return;
        const {r, c} = selectedCell;
        
        // åˆå§‹æ•°å­—ä¸å¯æ”¹
        if (initialBoard[r][c] !== 0) return;
        
        // å·²ç»å¡«å¯¹çš„æ•°å­—ä¸å¯æ”¹ (é˜²æ­¢è¯¯æ“ä½œ)
        if (board[r][c] === solution[r][c]) return;

        if (isNoteMode) {
            saveHistory();
            // ç¬”è®°æ¨¡å¼ï¼šåˆ‡æ¢
            if (notes[r][c].has(num)) notes[r][c].delete(num);
            else notes[r][c].add(num);
        } else {
            // ğŸ”¥ å¡«å…¥æ¨¡å¼ï¼šå®æ—¶åˆ¤é”™
            if (num !== solution[r][c]) {
                // å¡«é”™äº†ï¼
                mistakes++;
                document.getElementById('mistake-count').textContent = mistakes;
                // è§†è§‰åé¦ˆï¼šå…ˆå¡«å…¥é”™è¯¯æ•°å­—å±•ç¤ºä¸€ä¸‹ï¼Œå¹¶æ ‡è®°error
                // è¿™é‡Œçš„é€»è¾‘ï¼šå¤§å¤šæ•°Appä¼šæ˜¾ç¤ºé”™è¯¯æ•°å­—ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ¸…é™¤æˆ–æ›¿æ¢
                saveHistory();
                board[r][c] = num; 
                
                // æ£€æŸ¥å¤±è´¥æ¡ä»¶ (å¯é€‰ï¼Œè¿™é‡Œåªè®¡æ•°ä¸å¼ºé€€)
                // if(mistakes >= 3) gameOver(); 
            } else {
                // å¡«å¯¹äº†ï¼
                saveHistory();
                board[r][c] = num;
                notes[r][c].clear(); // æ¸…ç©ºå½“å‰æ ¼ç¬”è®°
                
                // ğŸ”¥ æ™ºèƒ½æ“¦é™¤ç¬”è®°ï¼šæ¸…é™¤åŒè¡Œã€åŒåˆ—ã€åŒå®«ä¸­å¯¹åº”çš„ç¬”è®°
                autoEraseNotes(r, c, num);
            }
        }
        
        renderBoard();
        checkWin();
    }

    // ğŸ”¥ æ™ºèƒ½æ“¦é™¤ç¬”è®°åŠŸèƒ½
    function autoEraseNotes(r, c, num) {
        // è¡Œ
        for(let i=0; i<9; i++) notes[r][i].delete(num);
        // åˆ—
        for(let i=0; i<9; i++) notes[i][c].delete(num);
        // å®«
        const startR = Math.floor(r/3)*3;
        const startC = Math.floor(c/3)*3;
        for(let i=0; i<3; i++) {
            for(let j=0; j<3; j++) {
                notes[startR+i][startC+j].delete(num);
            }
        }
    }

    function erase() {
        if (isGameOver || !selectedCell) return;
        const {r, c} = selectedCell;
        if (initialBoard[r][c] !== 0) return;
        // é˜²æ­¢æ“¦é™¤å·²é”å®šçš„æ­£ç¡®ç­”æ¡ˆ
        if (board[r][c] === solution[r][c]) return;
        
        saveHistory();
        board[r][c] = 0;
        renderBoard();
    }

    // æç¤ºåŠŸèƒ½
    function checkHint() {
        if (isGameOver || !selectedCell) return;
        const {r, c} = selectedCell;
        if (board[r][c] !== 0) return; // å·²æœ‰æ•°å­—ä¸æç¤º

        saveHistory();
        const correctNum = solution[r][c];
        board[r][c] = correctNum;
        notes[r][c].clear();
        autoEraseNotes(r, c, correctNum);
        renderBoard();
        checkWin();
    }

    function undo() {
        if (isGameOver || history.length === 0) return;
        const lastState = history.pop();
        board = JSON.parse(lastState.board);
        notes = JSON.parse(lastState.notes).map(arr => new Set(arr));
        renderBoard();
    }

    function saveHistory() {
        if (history.length > 20) history.shift();
        const notesArray = notes.map(row => row.map(set => Array.from(set)));
        history.push({
            board: JSON.stringify(board),
            notes: JSON.stringify(notesArray)
        });
    }

    function toggleNoteMode() {
        isNoteMode = !isNoteMode;
        const btn = document.getElementById('btn-note');
        const text = document.getElementById('note-text');
        if (isNoteMode) {
            btn.classList.add('active');
            text.textContent = "ç¬”è®°: å¼€";
        } else {
            btn.classList.remove('active');
            text.textContent = "ç¬”è®°: å…³";
        }
    }

    // --- æ¸²æŸ“ç³»ç»Ÿ ---
    function renderBoard() {
        highlightBoard();
        
        // ç»Ÿè®¡æ¯ä¸ªæ•°å­—å‡ºç°çš„æ¬¡æ•° (åªç»Ÿè®¡å¡«å¯¹çš„)
        const numCounts = Array(10).fill(0);

        for(let r=0; r<9; r++) {
            for(let c=0; c<9; c++) {
                const cell = document.getElementById(`cell-${r}-${c}`);
                const val = board[r][c];
                
                // ç»Ÿè®¡æ•°å­—
                if (val === solution[r][c]) numCounts[val]++;

                // æ¸…ç†DOM
                const noteGrid = cell.querySelector('.notes-grid');
                Array.from(cell.childNodes).forEach(n => {
                    if(n.nodeType === 3) cell.removeChild(n);
                });

                cell.classList.remove('user-input', 'fixed', 'error');

                if (val !== 0) {
                    cell.appendChild(document.createTextNode(val));
                    noteGrid.style.display = 'none';
                    
                    if (initialBoard[r][c] !== 0) {
                        cell.classList.add('fixed');
                    } else {
                        cell.classList.add('user-input');
                        // åˆ¤é”™æ ‡çº¢
                        if (val !== solution[r][c]) cell.classList.add('error');
                    }
                } else {
                    noteGrid.style.display = 'grid';
                    for(let i=1; i<=9; i++) {
                        const noteEl = document.getElementById(`note-${r}-${c}-${i}`);
                        noteEl.textContent = notes[r][c].has(i) ? i : '';
                    }
                }
            }
        }

        // ğŸ”¥ æ›´æ–°é”®ç›˜çŠ¶æ€ï¼šå¦‚æœæŸä¸ªæ•°å­—å·²å¡«æ»¡9ä¸ªï¼Œå°†æŒ‰é’®ç½®ç°
        for(let i=1; i<=9; i++) {
            const btn = document.getElementById(`btn-num-${i}`);
            if (numCounts[i] === 9) btn.classList.add('completed');
            else btn.classList.remove('completed');
        }
    }

    function highlightBoard() {
        document.querySelectorAll('.cell').forEach(c => {
            c.classList.remove('selected', 'highlight', 'same-number');
        });

        if (!selectedCell) return;
        const {r: sr, c: sc} = selectedCell;
        const selectedVal = board[sr][sc];

        // é«˜äº®è¡Œã€åˆ—ã€å®«
        for (let i = 0; i < 9; i++) {
            document.getElementById(`cell-${sr}-${i}`).classList.add('highlight');
            document.getElementById(`cell-${i}-${sc}`).classList.add('highlight');
        }
        const startR = Math.floor(sr / 3) * 3;
        const startC = Math.floor(sc / 3) * 3;
        for(let i=0; i<3; i++) {
            for(let j=0; j<3; j++) {
                document.getElementById(`cell-${startR+i}-${startC+j}`).classList.add('highlight');
            }
        }

        // é«˜äº®é€‰ä¸­æ ¼
        const cur = document.getElementById(`cell-${sr}-${sc}`);
        cur.classList.remove('highlight');
        cur.classList.add('selected');

        // é«˜äº®ç›¸åŒæ•°å­—
        if (selectedVal !== 0) {
            for(let r=0; r<9; r++) {
                for(let c=0; c<9; c++) {
                    if (board[r][c] === selectedVal) {
                        document.getElementById(`cell-${r}-${c}`).classList.add('same-number');
                    }
                }
            }
        }
    }

    function checkWin() {
        // èƒœåˆ©æ¡ä»¶ï¼šæ£‹ç›˜å¡«æ»¡ä¸”æ— é”™è¯¯ (å› ä¸ºæˆ‘ä»¬å®æ—¶åˆ¤é”™ï¼Œæ‰€ä»¥åªè¦å¡«æ»¡ä¸”å’Œsolutionä¸€è‡´å³å¯)
        for(let r=0; r<9; r++) {
            for(let c=0; c<9; c++) {
                if (board[r][c] !== solution[r][c]) return;
            }
        }

        isGameOver = true;
        clearInterval(timerInterval);
        
        // æ˜¾ç¤ºç»“ç®—ç”»é¢
        document.getElementById('final-time').textContent = formatTime(timeSeconds);
        document.getElementById('final-mistakes').textContent = mistakes;
        document.getElementById('win-overlay').classList.add('show');
    }

    function closeWinOverlay() {
        newGame();
    }

    function updateTimer() {
        timeSeconds++;
        document.getElementById('timer').textContent = formatTime(timeSeconds);
    }

    function formatTime(s) {
        const m = Math.floor(s / 60).toString().padStart(2, '0');
        const sec = (s % 60).toString().padStart(2, '0');
        return `${m}:${sec}`;
    }

    // é”®ç›˜ç›‘å¬
    document.addEventListener('keydown', (e) => {
        if(isGameOver) return;
        const key = e.key;
        if (key >= '1' && key <= '9') inputNumber(parseInt(key));
        if (key === 'Backspace' || key === 'Delete') erase();
        if (key.toLowerCase() === 'n') toggleNoteMode();
        if (key === 'ArrowUp') moveSelection(-1, 0);
        if (key === 'ArrowDown') moveSelection(1, 0);
        if (key === 'ArrowLeft') moveSelection(0, -1);
        if (key === 'ArrowRight') moveSelection(0, 1);
    });

    function moveSelection(dr, dc) {
        if (!selectedCell) { selectCell(0, 0); return; }
        let r = selectedCell.r + dr;
        let c = selectedCell.c + dc;
        if (r >= 0 && r < 9 && c >= 0 && c < 9) selectCell(r, c);
    }

    initUI();
    newGame();

</script>
</body>
</html>