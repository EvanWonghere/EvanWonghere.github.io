<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Emoji</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #70c5ce; /* ç»å…¸è“å¤© */
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
            user-select: none;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .panel {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            pointer-events: auto;
            border: 4px solid #543847;
        }
        .hidden { display: none !important; }

        h1 { margin: 0 0 10px; color: #543847; font-size: 2rem; }
        p { color: #888; margin-bottom: 20px; }

        .char-selector {
            display: flex; gap: 15px; margin-bottom: 20px; justify-content: center;
        }
        .char-btn {
            font-size: 2rem;
            background: #eee;
            border: 2px solid #ccc;
            border-radius: 10px;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.1s, background 0.2s;
        }
        .char-btn.selected {
            background: #ffe066;
            border-color: #fca311;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(252, 163, 17, 0.4);
        }
        
        .btn-start {
            background: #e056fd;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 1.2rem;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 #be2edd;
            transition: transform 0.1s;
        }
        .btn-start:active { transform: translateY(5px); box-shadow: none; }

        #score-hud {
            position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
            font-size: 4rem; font-weight: bold; color: white;
            text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 5;
        }
    </style>
</head>
<body>

<div id="score-hud">0</div>

<div id="ui-layer">
    <div id="start-screen" class="panel">
        <h1>Flappy Emoji</h1>
        <p>Choose your hero</p>
        <div class="char-selector">
            <div class="char-btn selected" onclick="selectChar('ğŸ¦')">ğŸ¦</div>
            <div class="char-btn" onclick="selectChar('ğŸš€')">ğŸš€</div>
            <div class="char-btn" onclick="selectChar('ğŸ‘»')">ğŸ‘»</div>
            <div class="char-btn" onclick="selectChar('ğŸ±')">ğŸ±</div>
        </div>
        <button class="btn-start" onclick="startGame()">PLAY</button>
    </div>

    <div id="game-over-screen" class="panel hidden">
        <h1>GAME OVER</h1>
        <p>Score: <span id="final-score">0</span></p>
        <p>Best: <span id="best-score">0</span></p>
        <button class="btn-start" onclick="resetGame()">RETRY</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-hud');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');

    // é…ç½®
    let avatar = 'ğŸ¦';
    let gameSpeed = 3;
    let gravity = 0.25;
    let jumpStrength = -6.5; // è·³è·ƒåŠ›åº¦
    
    // çŠ¶æ€
    let state = 'menu'; // menu, playing, dead
    let frames = 0;
    let score = 0;
    let bestScore = localStorage.getItem('flappy_best') || 0;

    // å®ä½“
    const bird = {
        x: 50, y: 150, w: 30, h: 30,
        velocity: 0, rotation: 0,
        radius: 12
    };
    
    const pipes = [];
    
    // éŸ³æ•ˆåˆæˆ
    const AudioSys = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        play(type) {
            if (this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            osc.connect(g); g.connect(this.ctx.destination);
            const t = this.ctx.currentTime;
            
            if (type === 'jump') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, t);
                osc.frequency.linearRampToValueAtTime(500, t+0.1);
                g.gain.setValueAtTime(0.1, t);
                g.gain.linearRampToValueAtTime(0, t+0.1);
                osc.start(t); osc.stop(t+0.1);
            } else if (type === 'score') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(600, t);
                g.gain.setValueAtTime(0.05, t);
                g.gain.linearRampToValueAtTime(0, t+0.1);
                osc.start(t); osc.stop(t+0.1);
            } else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, t);
                g.gain.setValueAtTime(0.1, t);
                g.gain.linearRampToValueAtTime(0, t+0.3);
                osc.start(t); osc.stop(t+0.3);
            }
        }
    };

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        bird.x = canvas.width * 0.3; // é¸Ÿçš„ä½ç½®ç›¸å¯¹å›ºå®š
    }
    window.addEventListener('resize', resize);
    resize();

    function selectChar(char) {
        avatar = char;
        document.querySelectorAll('.char-btn').forEach(btn => {
            btn.classList.remove('selected');
            if (btn.innerText === char) btn.classList.add('selected');
        });
    }

    function startGame() {
        state = 'playing';
        startScreen.classList.add('hidden');
        resetLogic();
        loop();
    }

    function resetGame() {
        state = 'menu';
        gameOverScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
    }

    function resetLogic() {
        bird.y = canvas.height / 2;
        bird.velocity = 0;
        bird.rotation = 0;
        pipes.length = 0;
        score = 0;
        frames = 0;
        scoreEl.innerText = 0;
    }

    function jump() {
        if (state !== 'playing') return;
        bird.velocity = jumpStrength;
        AudioSys.play('jump');
    }

    // è¾“å…¥
    window.addEventListener('keydown', e => { if (e.code === 'Space') jump(); });
    window.addEventListener('touchstart', e => { e.preventDefault(); jump(); }, {passive: false});
    window.addEventListener('mousedown', jump);

    // å¾ªç¯
    function loop() {
        if (state === 'menu') return;

        update();
        draw();

        if (state === 'playing') {
            requestAnimationFrame(loop);
        }
    }

    function update() {
        frames++;

        // é¸Ÿç‰©ç†
        bird.velocity += gravity;
        bird.y += bird.velocity;

        // æ—‹è½¬è®¡ç®— (ä¸‹è½æ—¶å¤´æœä¸‹)
        if (bird.velocity < 0) bird.rotation = -25 * Math.PI / 180;
        else {
            bird.rotation += 2 * Math.PI / 180;
            if (bird.rotation > 90 * Math.PI / 180) bird.rotation = 90 * Math.PI / 180;
        }

        // åœ°é¢/å¤©èŠ±æ¿ç¢°æ’
        if (bird.y + bird.radius >= canvas.height || bird.y - bird.radius <= 0) {
            die();
        }

        // ç®¡é“é€»è¾‘
        // ç§»åŠ¨ç®¡é“
        for (let i = 0; i < pipes.length; i++) {
            pipes[i].x -= gameSpeed;
            
            // ç¢°æ’æ£€æµ‹
            const p = pipes[i];
            // Xè½´é‡å 
            if (bird.x + bird.radius > p.x && bird.x - bird.radius < p.x + p.w) {
                // Yè½´é‡å  (æ’ä¸Šç®¡è¿˜æ˜¯æ’ä¸‹ç®¡)
                if (bird.y - bird.radius < p.top || bird.y + bird.radius > canvas.height - p.bottom) {
                    die();
                }
            }

            // åŠ åˆ†
            if (p.x + p.w < bird.x && !p.passed) {
                score++;
                scoreEl.innerText = score;
                p.passed = true;
                AudioSys.play('score');
            }

            // ç§»é™¤
            if (p.x + p.w < 0) {
                pipes.shift();
                i--;
            }
        }

        // ç”Ÿæˆç®¡é“ (é—´éš”æ ¹æ®å±å¹•å®½åº¦åŠ¨æ€è°ƒæ•´ï¼Œçº¦100å¸§)
        if (frames % 100 === 0) {
            const gap = 150; // é€šé“é«˜åº¦
            const minPipe = 50;
            const maxTop = canvas.height - minPipe - gap;
            const topHeight = Math.floor(Math.random() * (maxTop - minPipe + 1)) + minPipe;
            
            pipes.push({
                x: canvas.width,
                w: 60,
                top: topHeight,
                bottom: canvas.height - (topHeight + gap),
                passed: false
            });
        }
    }

    function die() {
        state = 'dead';
        AudioSys.play('hit');
        if (score > bestScore) {
            bestScore = score;
            localStorage.setItem('flappy_best', bestScore);
        }
        document.getElementById('final-score').innerText = score;
        document.getElementById('best-score').innerText = bestScore;
        gameOverScreen.classList.remove('hidden');
    }

    function draw() {
        // èƒŒæ™¯
        ctx.fillStyle = "#70c5ce";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // äº‘æœµè£…é¥°
        ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
        for(let i=0; i<5; i++) {
            ctx.beginPath();
            let x = ((frames * 0.5) + (i * 200)) % (canvas.width + 200) - 100;
            ctx.arc(x, canvas.height - 50 - (i%2)*30, 40, 0, Math.PI*2);
            ctx.fill();
        }

        // ç®¡é“
        ctx.fillStyle = "#73bf2e"; // ç»å…¸ç»¿
        ctx.strokeStyle = "#558c22";
        ctx.lineWidth = 3;
        pipes.forEach(p => {
            // ä¸Šç®¡
            ctx.fillRect(p.x, 0, p.w, p.top);
            ctx.strokeRect(p.x, -2, p.w, p.top + 2); // è¾¹æ¡†
            // ä¸‹ç®¡
            ctx.fillRect(p.x, canvas.height - p.bottom, p.w, p.bottom);
            ctx.strokeRect(p.x, canvas.height - p.bottom - 2, p.w, p.bottom + 4);
            
            // ç®¡å£è£…é¥°
            ctx.fillStyle = "#8edd3f"; // é«˜å…‰
            ctx.fillRect(p.x + 5, 0, 10, p.top); 
            ctx.fillRect(p.x + 5, canvas.height - p.bottom, 10, p.bottom); 
            ctx.fillStyle = "#73bf2e"; // è¿˜åŸ
        });

        // åœ°é¢
        ctx.fillStyle = "#ded895";
        ctx.fillRect(0, canvas.height - 20, canvas.width, 20);
        ctx.fillStyle = "#73bf2e"; // è‰çš®
        ctx.fillRect(0, canvas.height - 20, canvas.width, 5);

        // é¸Ÿ (Emoji)
        ctx.save();
        ctx.translate(bird.x, bird.y);
        ctx.rotate(bird.rotation);
        ctx.font = "36px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        // ç¨å¾®è°ƒæ•´ emoji çš„ä¸­å¿ƒ
        ctx.fillText(avatar, 0, 2); 
        ctx.restore();
    }
    
    // åˆå§‹ç”»é¢
    draw();
    
</script>
</body>
</html>
