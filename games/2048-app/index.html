<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2048</title>
    <style>
        :root {
            --bg-color: #faf8ef;
            --text-color: #776e65;
            --grid-bg: #bbada0;
            --cell-empty: #cdc1b4;
            --button-bg: #8f7a66;
            --button-text: #f9f6f2;
            
            /* æ–¹å—é¢œè‰²å®šä¹‰ */
            --tile-2: #eee4da; --text-2: #776e65;
            --tile-4: #ede0c8; --text-4: #776e65;
            --tile-8: #f2b179; --text-8: #f9f6f2;
            --tile-16: #f59563; --text-16: #f9f6f2;
            --tile-32: #f67c5f; --text-32: #f9f6f2;
            --tile-64: #f65e3b; --text-64: #f9f6f2;
            --tile-128: #edcf72; --text-128: #f9f6f2;
            --tile-256: #edcc61; --text-256: #f9f6f2;
            --tile-512: #edc850; --text-512: #f9f6f2;
            --tile-1024: #edc53f; --text-1024: #f9f6f2;
            --tile-2048: #edc22e; --text-2048: #f9f6f2;
            --tile-super: #3c3a32; --text-super: #f9f6f2;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121213;
                --text-color: #f9f6f2;
                --grid-bg: #3c3a32; /* æ·±è‰²èƒŒæ™¯ä¸‹çš„ç½‘æ ¼è‰² */
                --cell-empty: #4a4641; /* ç©ºæ ¼å­çš„é¢œè‰² */
                
                /* æ•°å­—å—åœ¨æ·±è‰²æ¨¡å¼ä¸‹ç¨å¾®è°ƒæ•´ä¸€ä¸‹äº®åº¦ï¼Œä¿æŒåŸå‘³å³å¯ */
            }
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Clear Sans", "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤çš„æ»šåŠ¨è¡Œä¸º */
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 300px; /* ç§»åŠ¨ç«¯åŸºç¡€å®½åº¦ */
            margin-top: 20px;
        }

        h1 { font-size: 40px; margin: 0; font-weight: bold; }

        .scores-container {
            display: flex;
            gap: 5px;
        }

        .score-box {
            background: var(--grid-bg);
            padding: 5px 15px;
            border-radius: 3px;
            color: white;
            text-align: center;
            min-width: 50px;
        }

        .score-label { font-size: 10px; text-transform: uppercase; color: #eee4da; }
        .score-val { font-size: 18px; font-weight: bold; }

        .above-game {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 300px;
            margin: 10px 0;
        }

        .game-intro { font-size: 14px; color: var(--text-color); opacity: 0.8; margin: 0; }
        
        .restart-btn {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 3px;
            padding: 0 15px;
            height: 35px;
            line-height: 35px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        /* æ¸¸æˆæ£‹ç›˜ */
        .game-container {
            position: relative;
            width: 300px;
            height: 300px;
            padding: 10px;
            background: var(--grid-bg);
            border-radius: 6px;
            box-sizing: border-box;
        }

        .grid-container {
            position: absolute;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            width: 280px;
            height: 280px;
        }

        .grid-cell {
            background: var(--cell-empty);
            border-radius: 3px;
            width: 100%;
            height: 100%;
        }

        .tile-container {
            position: absolute;
            z-index: 2;
            top: 10px; left: 10px; /* å¯¹åº” padding */
            width: 280px; height: 280px;
        }

        .tile {
            position: absolute;
            width: 62.5px; /* (280 - 3*10) / 4 */
            height: 62.5px;
            border-radius: 3px;
            background: #eee4da;
            text-align: center;
            font-weight: bold;
            z-index: 10;
            font-size: 30px;
            line-height: 62.5px;
            transition: transform 100ms ease-in-out;
            /* åˆå§‹ä½ç½®ç”± JS è®¡ç®— transform */
        }

        /* åŠ¨ç”»ç±» */
        .tile-new { animation: appear 200ms ease; }
        .tile-merged { animation: pop 200ms ease; z-index: 20; }

        @keyframes appear {
            0% { opacity: 0; transform: scale(0); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* ä¸åŒæ•°å­—çš„é¢œè‰² */
        .tile.val-2 { background: var(--tile-2); color: var(--text-2); }
        .tile.val-4 { background: var(--tile-4); color: var(--text-4); }
        .tile.val-8 { background: var(--tile-8); color: var(--text-8); }
        .tile.val-16 { background: var(--tile-16); color: var(--text-16); }
        .tile.val-32 { background: var(--tile-32); color: var(--text-32); }
        .tile.val-64 { background: var(--tile-64); color: var(--text-64); }
        .tile.val-128 { background: var(--tile-128); color: var(--text-128); font-size: 24px; }
        .tile.val-256 { background: var(--tile-256); color: var(--text-256); font-size: 24px; }
        .tile.val-512 { background: var(--tile-512); color: var(--text-512); font-size: 24px; }
        .tile.val-1024 { background: var(--tile-1024); color: var(--text-1024); font-size: 18px; }
        .tile.val-2048 { background: var(--tile-2048); color: var(--text-2048); font-size: 18px; }
        .tile.val-super { background: var(--tile-super); color: var(--text-super); font-size: 16px; }

        /* æ¸¸æˆç»“æŸ/èƒœåˆ© é®ç½© */
        .game-message {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(238, 228, 218, 0.73);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 6px;
        }
        @media (prefers-color-scheme: dark) {
            .game-message { background: rgba(0, 0, 0, 0.7); }
        }

        .game-message.game-over { display: flex; }
        .game-message p { font-size: 40px; font-weight: bold; margin: 0 0 20px 0; color: #776e65; }
        @media (prefers-color-scheme: dark) { .game-message p { color: #f9f6f2; } }

        /* å“åº”å¼æ”¾å¤§ï¼šåœ¨å¤§å±å¹•ä¸Šç¨å¾®å¤§ä¸€ç‚¹ */
        @media (min-width: 500px) {
            .header-container, .above-game, .game-container { width: 400px; }
            .game-container { height: 400px; padding: 15px; }
            .grid-container { width: 370px; height: 370px; gap: 15px; }
            .tile-container { width: 370px; height: 370px; top: 15px; left: 15px; }
            .tile { width: 81.25px; height: 81.25px; line-height: 81.25px; font-size: 45px; }
            .tile.val-128, .tile.val-256, .tile.val-512 { font-size: 36px; }
            .tile.val-1024, .tile.val-2048 { font-size: 28px; }
        }
    </style>
</head>
<body>

<div class="header-container">
    <h1>2048</h1>
    <div class="scores-container">
        <div class="score-box">
            <div class="score-label">SCORE</div>
            <div class="score-val" id="score">0</div>
        </div>
        <div class="score-box">
            <div class="score-label">BEST</div>
            <div class="score-val" id="best-score">0</div>
        </div>
    </div>
</div>

<div class="above-game">
    <p class="game-intro">åˆå¹¶æ–¹å—ä»¥è¾¾åˆ° <strong>2048!</strong></p>
    <button class="restart-btn" onclick="restartGame()">æ–°æ¸¸æˆ</button>
</div>

<div class="game-container">
    <div class="game-message" id="game-message">
        <p id="game-msg-text"></p>
        <button class="restart-btn" onclick="restartGame()">å†æ¥ä¸€å±€</button>
    </div>

    <div class="grid-container">
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
    </div>

    <div class="tile-container" id="tile-container">
        </div>
</div>

<script>
    // æ¸¸æˆé…ç½®
    const SIZE = 4;
    let board = [];
    let score = 0;
    let bestScore = localStorage.getItem('2048-best') || 0;
    let won = false;
    let gameOver = false;

    const tileContainer = document.getElementById('tile-container');
    const scoreEl = document.getElementById('score');
    const bestScoreEl = document.getElementById('best-score');
    const msgContainer = document.getElementById('game-message');
    const msgText = document.getElementById('game-msg-text');

    bestScoreEl.textContent = bestScore;

    // åˆå§‹åŒ–
    function init() {
        board = Array(SIZE).fill(null).map(() => Array(SIZE).fill(0));
        score = 0;
        won = false;
        gameOver = false;
        updateScore(0);
        
        msgContainer.classList.remove('game-over');
        tileContainer.innerHTML = '';

        addRandomTile();
        addRandomTile();
        renderBoard();
    }

    function restartGame() {
        init();
    }

    // æ ¸å¿ƒé€»è¾‘ï¼šç§»åŠ¨
    function move(direction) {
        if (gameOver) return;

        // direction: 0:Up, 1:Right, 2:Down, 3:Left
        let moved = false;
        let scoreGain = 0;

        // ä¸ºäº†ç»Ÿä¸€é€»è¾‘ï¼Œæˆ‘ä»¬å°†é¢æ¿æ—‹è½¬åˆ°ç»Ÿä¸€æ–¹å‘ï¼ˆå‘å·¦ï¼‰å¤„ç†ï¼Œå¤„ç†å®Œå†è½¬å›å»
        // å‘å·¦: 0æ—‹, å‘å³: 2æ—‹, å‘ä¸Š: 3æ—‹(é€†æ—¶é’ˆ), å‘ä¸‹: 1æ—‹
        // ä½†ä¸ºäº†ä¿æŒåæ ‡æ˜ å°„ç®€å•ï¼Œæˆ‘ä»¬åˆ†åˆ«å¤„ç†å››ä¸ªæ–¹å‘çš„éå†é€»è¾‘
        
        // å‘é‡ï¼šUp(-1,0), Right(0,1), Down(1,0), Left(0,-1)
        const vectors = [
            {r: -1, c: 0}, // Up
            {r: 0, c: 1},  // Right
            {r: 1, c: 0},  // Down
            {r: 0, c: -1}  // Left
        ];
        const vector = vectors[direction];

        // éå†é¡ºåºï¼š
        // Up: rä»1åˆ°3, cä»0åˆ°3
        // Right: cä»2åˆ°0, rä»0åˆ°3
        // Down: rä»2åˆ°0, cä»0åˆ°3
        // Left: cä»1åˆ°3, rä»0åˆ°3
        
        // ç®€åŒ–ï¼šæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ merged æ ‡è®°æ•°ç»„ï¼Œé˜²æ­¢ä¸€æ¬¡ç§»åŠ¨ä¸­é‡å¤åˆå¹¶
        let merged = Array(SIZE).fill(null).map(() => Array(SIZE).fill(false));

        // æ„å»ºéå†åºåˆ—
        let traversals = { r: [], c: [] };
        for (let pos = 0; pos < SIZE; pos++) {
            traversals.r.push(pos);
            traversals.c.push(pos);
        }

        // å¦‚æœæ˜¯å‘å³æˆ–å‘ä¸‹ï¼Œéœ€è¦åå‘éå†
        if (direction === 1) traversals.c.reverse(); // Right
        if (direction === 2) traversals.r.reverse(); // Down

        traversals.r.forEach(r => {
            traversals.c.forEach(c => {
                if (board[r][c] === 0) return;

                let cell = { r: r, c: c };
                let next = null;
                let tileValue = board[r][c];

                // å¯»æ‰¾æœ€è¿œçš„ç©ºä½
                let farthest = cell;
                while (true) {
                    next = { r: farthest.r + vector.r, c: farthest.c + vector.c };
                    if (!withinBounds(next) || board[next.r][next.c] !== 0) break;
                    farthest = next;
                }

                // next æ˜¯è¾¹ç•Œå¤–æˆ–è€…æœ‰æ–¹å—çš„ä½ç½®
                // æ£€æŸ¥ next æ˜¯å¦å¯åˆå¹¶
                let nextCell = next;
                
                if (withinBounds(nextCell) && board[nextCell.r][nextCell.c] === tileValue && !merged[nextCell.r][nextCell.c]) {
                    // åˆå¹¶ï¼
                    board[nextCell.r][nextCell.c] *= 2;
                    board[r][c] = 0;
                    merged[nextCell.r][nextCell.c] = true;
                    scoreGain += board[nextCell.r][nextCell.c];
                    
                    // è§†è§‰åŠ¨ç”»ï¼šè¿™é‡Œç®€å•å¤„ç†ï¼Œç›´æ¥é‡æ–°æ¸²æŸ“ä¼šå¸¦å‡º new/merge ç±»
                    moved = true;
                    
                    if (board[nextCell.r][nextCell.c] === 2048 && !won) {
                        won = true;
                        setTimeout(() => alert("ğŸ‰ ä½ è¾¾åˆ°äº† 2048! ä½†ä½ å¯ä»¥ç»§ç»­æŒ‘æˆ˜æ›´é«˜åˆ†ã€‚"), 100);
                    }
                } else if (farthest.r !== r || farthest.c !== c) {
                    // ä»…ä»…æ˜¯ç§»åŠ¨
                    board[farthest.r][farthest.c] = tileValue;
                    board[r][c] = 0;
                    moved = true;
                }
            });
        });

        if (moved) {
            updateScore(score + scoreGain);
            addRandomTile();
            renderBoard();
            if (!movesAvailable()) {
                gameOver = true;
                showGameOver(false);
            }
        }
    }

    function withinBounds(pos) {
        return pos.r >= 0 && pos.r < SIZE && pos.c >= 0 && pos.c < SIZE;
    }

    function movesAvailable() {
        for (let r = 0; r < SIZE; r++) {
            for (let c = 0; c < SIZE; c++) {
                if (board[r][c] === 0) return true;
                if (c < SIZE - 1 && board[r][c] === board[r][c + 1]) return true;
                if (r < SIZE - 1 && board[r][c] === board[r + 1][c]) return true;
            }
        }
        return false;
    }

    function addRandomTile() {
        let emptyCells = [];
        for (let r = 0; r < SIZE; r++) {
            for (let c = 0; c < SIZE; c++) {
                if (board[r][c] === 0) emptyCells.push({r, c});
            }
        }
        if (emptyCells.length > 0) {
            let rand = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            board[rand.r][rand.c] = Math.random() < 0.9 ? 2 : 4;
            
            // æ ‡è®°è¿™ä¸ªä½ç½®æ˜¯æ–°ç”Ÿæˆçš„ï¼Œç”¨äºæ¸²æŸ“åŠ¨ç”»
            return {r: rand.r, c: rand.c, isNew: true};
        }
    }

    function updateScore(newScore) {
        score = newScore;
        scoreEl.textContent = score;
        if (score > bestScore) {
            bestScore = score;
            bestScoreEl.textContent = bestScore;
            localStorage.setItem('2048-best', bestScore);
        }
    }

    function showGameOver(win) {
        msgText.textContent = win ? "You Win!" : "Game Over!";
        msgContainer.classList.add('game-over');
    }

    // æ¸²æŸ“é€»è¾‘
    // æ³¨æ„ï¼šä¸ºäº†ç®€åŒ–å•æ–‡ä»¶é€»è¾‘ï¼Œè¿™é‡Œé‡‡ç”¨â€œå…¨é‡åˆ·æ–° DOMâ€çš„æ–¹å¼ã€‚
    // è™½ç„¶ä¸å¦‚ React/Vue çš„ Diff ç®—æ³•é«˜æ•ˆï¼Œä½†å¯¹äº 16 ä¸ªæ ¼å­æ¥è¯´ï¼Œè‚‰çœ¼æ— æ³•å¯Ÿè§‰å¡é¡¿ï¼Œä¸”èƒ½é€šè¿‡ CSS åŠ¨ç”»å®ç°å¾ˆå¥½çš„æ•ˆæœã€‚
    function renderBoard() {
        tileContainer.innerHTML = '';
        
        // è®¡ç®—æ ¼å­å¤§å°å’Œé—´è·ï¼Œç”¨äºç»å¯¹å®šä½
        // é»˜è®¤ç§»åŠ¨ç«¯: å®¹å™¨280px, é—´è·10px, æ ¼å­62.5px
        // å¤§å±: å®¹å™¨370px, é—´è·15px, æ ¼å­81.25px
        const isBig = window.innerWidth >= 500;
        const gap = isBig ? 15 : 10;
        const size = isBig ? 81.25 : 62.5;

        for (let r = 0; r < SIZE; r++) {
            for (let c = 0; c < SIZE; c++) {
                if (board[r][c] !== 0) {
                    const tile = document.createElement('div');
                    const val = board[r][c];
                    tile.textContent = val;
                    tile.className = `tile val-${val > 2048 ? 'super' : val}`;
                    
                    // è®¡ç®—ä½ç½®
                    const left = c * (size + gap);
                    const top = r * (size + gap);
                    
                    // åº”ç”¨ä½ç½®
                    tile.style.transform = `translate(${left}px, ${top}px)`;
                    
                    // è¿™é‡Œæˆ‘ä»¬æ— æ³•ç®€å•çš„åˆ¤æ–­ "new" æˆ– "merged" çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬æ¯æ¬¡éƒ½æ¸…ç©ºäº†ã€‚
                    // ä¸ºäº†ä¿è¯åŠ¨ç”»ï¼ŒçœŸå®çš„é«˜æ€§èƒ½ 2048 ä¼šç»´æŠ¤ DOM èŠ‚ç‚¹ä¸åˆ é™¤ï¼Œåªæ›´æ–° class å’Œ transformã€‚
                    // ç®€åŒ–ç‰ˆå¦¥åï¼šæˆ‘ä»¬åªç»™æ–°ç”Ÿæˆçš„æ•°å­—åŠ  appear åŠ¨ç”»ï¼ˆä¾é CSSï¼‰ï¼Œç§»åŠ¨åŠ¨ç”»åˆ™æ²¡æœ‰å¹³æ»‘è¿‡æ¸¡ã€‚
                    // ä¸è¿‡ 2048 çš„æ ¸å¿ƒåœ¨äºæ•°å­—å˜åŒ–çš„ pop åŠ¨ç”»ï¼Œè¿™é‡Œç®€å•å¤„ç†ã€‚
                    
                    tileContainer.appendChild(tile);
                }
            }
        }
    }

    // --- è¾“å…¥ç›‘å¬ ---
    
    // é”®ç›˜
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp') { e.preventDefault(); move(0); }
        else if (e.key === 'ArrowRight') { e.preventDefault(); move(1); }
        else if (e.key === 'ArrowDown') { e.preventDefault(); move(2); }
        else if (e.key === 'ArrowLeft') { e.preventDefault(); move(3); }
    });

    // è§¦æ‘¸ (Swipe)
    let touchStartX = 0;
    let touchStartY = 0;
    const gameContainer = document.querySelector('.game-container');

    gameContainer.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) return;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
    }, {passive: false});

    gameContainer.addEventListener('touchmove', (e) => {
        e.preventDefault(); // å…³é”®ï¼šé˜²æ­¢æ»‘åŠ¨æ¸¸æˆæ—¶é¡µé¢æ»šåŠ¨
    }, {passive: false});

    gameContainer.addEventListener('touchend', (e) => {
        if (e.changedTouches.length > 0) {
            let touchEndX = e.changedTouches[0].clientX;
            let touchEndY = e.changedTouches[0].clientY;

            let dx = touchEndX - touchStartX;
            let dy = touchEndY - touchStartY;

            if (Math.max(Math.abs(dx), Math.abs(dy)) > 30) { // é˜ˆå€¼
                if (Math.abs(dx) > Math.abs(dy)) {
                    // æ°´å¹³
                    move(dx > 0 ? 1 : 3);
                } else {
                    // å‚ç›´
                    move(dy > 0 ? 2 : 0);
                }
            }
        }
    });

    init();
    
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ¸²æŸ“ä»¥é€‚é…åæ ‡
    window.addEventListener('resize', renderBoard);

</script>
</body>
</html>
