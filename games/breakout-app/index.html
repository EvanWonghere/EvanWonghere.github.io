<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Breakout Prism</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Fredoka+One&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºç¡€å¸ƒå±€ --- */
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: none;
            transition: background 0.5s;
        }

        #ui-container {
            position: absolute;
            top: 20px;
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 10;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ° Canvas */
        }

        .score-box {
            text-align: center;
            transition: color 0.3s;
        }
        .score-label { font-size: 14px; opacity: 0.8; }
        .score-val { font-size: 24px; font-weight: bold; }

        /* ä¸»é¢˜åˆ‡æ¢å™¨ (å¯ç‚¹å‡») */
        .theme-selector {
            pointer-events: auto;
            display: flex;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 5px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }
        
        .theme-btn {
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            opacity: 0.6;
            transition: all 0.3s;
        }
        .theme-btn.active { opacity: 1; transform: scale(1.1); }

        canvas {
            display: block;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: border 0.5s, box-shadow 0.5s;
            cursor: none; /* éšè—é¼ æ ‡ï¼Œç”¨æŒ¡æ¿ä»£æ›¿ */
        }

        /* æ¸¸æˆå¼€å§‹/ç»“æŸ è¦†ç›–å±‚ */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            backdrop-filter: blur(4px);
            transition: opacity 0.3s;
        }
        #overlay.hidden { opacity: 0; pointer-events: none; }
        
        h1 { font-size: 3rem; margin-bottom: 10px; color: white; text-transform: uppercase; }
        .btn-start {
            padding: 15px 40px;
            font-size: 1.5rem;
            cursor: pointer;
            border: none;
            border-radius: 50px;
            background: white;
            color: black;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn-start:active { transform: scale(0.95); }

        /* --- ä¸»é¢˜æ ·å¼ --- */

        /* 1. Neon (é»˜è®¤) */
        body.theme-neon {
            background: #050505;
            color: #0ff;
            font-family: 'Orbitron', sans-serif;
        }
        body.theme-neon canvas {
            border: 2px solid #333;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        body.theme-neon .theme-btn { background: #333; color: #fff; }
        body.theme-neon .theme-btn.active { background: #0ff; color: #000; box-shadow: 0 0 10px #0ff; }

        /* 2. Candy */
        body.theme-candy {
            background: #fff0f5; /* Lavender Blush */
            color: #ff6b6b;
            font-family: 'Fredoka One', cursive;
        }
        body.theme-candy canvas {
            border: 8px solid #fff;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
            background: #ffeaa7;
        }
        body.theme-candy .theme-btn { background: #fff; color: #ff6b6b; }
        body.theme-candy .theme-btn.active { background: #ff6b6b; color: #fff; }
        body.theme-candy #overlay { background: rgba(255, 255, 255, 0.8); }
        body.theme-candy h1 { color: #ff6b6b; text-shadow: 2px 2px 0px #fff; }
        body.theme-candy .btn-start { background: #ff6b6b; color: white; box-shadow: 0 5px 0 #e05555; }

        /* 3. Retro */
        body.theme-retro {
            background: #333;
            color: #42f54b; /* Terminal Green */
            font-family: 'VT323', monospace;
        }
        body.theme-retro canvas {
            border: 4px solid #42f54b;
            background: #000;
            box-shadow: none;
        }
        body.theme-retro .theme-selector { border: 1px solid #42f54b; background: black; border-radius: 0; }
        body.theme-retro .theme-btn { background: black; color: #42f54b; border: 1px solid #42f54b; border-radius: 0; }
        body.theme-retro .theme-btn.active { background: #42f54b; color: black; }
        body.theme-retro #overlay { background: rgba(0,0,0,0.9); }
        body.theme-retro h1 { font-family: 'VT323', monospace; color: #42f54b; text-shadow: 2px 2px #000; }
        body.theme-retro .btn-start { background: #000; color: #42f54b; border: 2px solid #42f54b; border-radius: 0; }

        /* CRT æ‰«æçº¿ (ä»… Retro æ¨¡å¼) */
        body.theme-retro::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            z-index: 5;
            pointer-events: none;
        }

        /* éš¾åº¦æŒ‰é’®æ ·å¼ */
        .diff-btn {
            padding: 8px 16px;
            background: transparent;
            border: 2px solid white;
            color: white;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.6;
            transition: 0.3s;
        }
        .diff-btn:hover { opacity: 1; }
        .diff-btn.active {
            background: white;
            color: black;
            opacity: 1;
            transform: scale(1.1);
        }
        /* é€‚é… Retro ä¸»é¢˜ */
        body.theme-retro .diff-btn { border-color: #42f54b; color: #42f54b; }
        body.theme-retro .diff-btn.active { background: #42f54b; color: black; }
        /* é€‚é… Candy ä¸»é¢˜ */
        body.theme-candy .diff-btn { border-color: #ff6b6b; color: #ff6b6b; }
        body.theme-candy .diff-btn.active { background: #ff6b6b; color: white; }
    </style>
</head>
<body class="theme-neon">

    <div id="ui-container">
        <div class="score-box">
            <div class="score-label">SCORE</div>
            <div class="score-val" id="score">0</div>
        </div>
        
        <div class="theme-selector">
            <button class="theme-btn active" onclick="setTheme('neon')">NEON</button>
            <button class="theme-btn" onclick="setTheme('candy')">CANDY</button>
            <button class="theme-btn" onclick="setTheme('retro')">RETRO</button>
        </div>
        
        <div class="score-box">
            <div class="score-label">LIVES</div>
            <div class="score-val" id="lives">3</div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="overlay">
        <h1 id="title-text">BREAKOUT</h1>
        
        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
            <button class="diff-btn" onclick="setDifficulty('easy')">EASY</button>
            <button class="diff-btn active" onclick="setDifficulty('normal')">NORMAL</button>
            <button class="diff-btn" onclick="setDifficulty('hard')">HARD</button>
        </div>

        <button class="btn-start" onclick="startGame()">START GAME</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlay');
    const titleText = document.getElementById('title-text');
    const btnStart = document.querySelector('.btn-start');

    // æ¸¸æˆé…ç½®
    let theme = 'neon';
    let isRunning = false;
    let score = 0;
    let lives = 3;
    let level = 1;

    // --- éš¾åº¦é…ç½® ---
    const DIFFICULTY_SETTINGS = {
        easy:   { paddleW: 120, ballSpeed: 4, dropRate: 0.25, lives: 5, speedInc: 1.01 },
        normal: { paddleW: 100, ballSpeed: 6, dropRate: 0.15, lives: 3, speedInc: 1.02 },
        hard:   { paddleW: 70,  ballSpeed: 9, dropRate: 0.08, lives: 2, speedInc: 1.04 }
    };
    let currentDiff = 'normal'; // é»˜è®¤éš¾åº¦

    // åˆ‡æ¢éš¾åº¦å‡½æ•°
    function setDifficulty(diff) {
        currentDiff = diff;
        // æ›´æ–°æŒ‰é’® UI
        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.classList.remove('active');
            // ç®€å•çš„æ–‡æœ¬åŒ¹é…æ£€æŸ¥
            if (btn.textContent.toLowerCase() === diff) btn.classList.add('active');
        });
    }

    // å®ä½“
    let paddle = { x: 0, y: 0, w: 100, h: 15, color: '#fff' };
    let balls = [];
    let bricks = [];
    let powerups = [];
    let particles = [];
    let lasers = []; // æ¿€å…‰å­å¼¹

    // çŠ¶æ€å¢ç›Š
    let paddleWidthMult = 1;
    let stickyPaddle = false;
    let hasLaser = false;
    let fireBallActive = false;
    let isInteractingUI = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æ“ä½œ UI

    // ä¸»é¢˜é…è‰²æ± 
    const PALETTES = {
        neon: { paddle: '#0ff', ball: '#fff', bg: 'rgba(0,0,0,0.2)', bricks: ['#f0f', '#f00', '#ff0', '#0f0', '#00f'] },
        candy: { paddle: '#ff6b6b', ball: '#333', bg: '#ffeaa7', bricks: ['#a29bfe', '#74b9ff', '#81ecec', '#55efc4', '#fab1a0'] },
        retro: { paddle: '#42f54b', ball: '#42f54b', bg: '#000', bricks: ['#42f54b', '#42f54b', '#42f54b', '#42f54b', '#42f54b'] }
    };

    // --- åˆå§‹åŒ– ---
    function resize() {
        canvas.width = Math.min(window.innerWidth, 600);
        canvas.height = Math.min(window.innerHeight, 800);
        if (paddle.y === 0) resetPaddle();
    }
    window.addEventListener('resize', resize);
    resize();

    function setTheme(newTheme) {
        theme = newTheme;
        document.body.className = `theme-${theme}`;
        
        // ä¸å†ä¾èµ– event.targetï¼Œè€Œæ˜¯éå†æŒ‰é’®åŒ¹é…æ–‡æœ¬
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase() === newTheme) {
                btn.classList.add('active');
            }
        });
    }

    function resetPaddle() {
        // [ä¿®æ”¹]ï¼šæ ¹æ®éš¾åº¦è®¾ç½®åˆå§‹å®½åº¦
        paddle.w = DIFFICULTY_SETTINGS[currentDiff].paddleW;
        paddle.h = 15;
        paddle.x = canvas.width / 2 - paddle.w / 2;
        paddle.y = canvas.height - 50;
        paddleWidthMult = 1;
        hasLaser = false;
        stickyPaddle = false;
    }

    function initLevel() {
        bricks = [];
        const rows = 5 + level; // éš¾åº¦éšå…³å¡å¢åŠ 
        const cols = 8;
        const padding = 10;
        const w = (canvas.width - padding * (cols + 1)) / cols;
        const h = 25;
        
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                // ç•™å‡ºé¡¶éƒ¨ç©ºé—´
                const brickY = 60 + r * (h + padding);
                // éšæœºè·³è¿‡ä¸€äº›ç –å—ï¼Œå¢åŠ è¶£å‘³æ€§
                if (Math.random() > 0.1) {
                    bricks.push({
                        x: padding + c * (w + padding),
                        y: brickY,
                        w: w, h: h,
                        val: Math.ceil((rows - r) / 2), // åˆ†æ•°
                        colorIdx: r % 5,
                        status: 1
                    });
                }
            }
        }
    }

    function spawnBall(x, y, speed) {
        // [ä¿®æ”¹]ï¼šå¦‚æœæ²¡æœ‰æŒ‡å®šé€Ÿåº¦ï¼Œä½¿ç”¨å½“å‰éš¾åº¦çš„é»˜è®¤é€Ÿåº¦
        const baseSpeed = speed || DIFFICULTY_SETTINGS[currentDiff].ballSpeed;
        
        balls.push({
            x: x || paddle.x + paddle.w * paddleWidthMult / 2,
            y: y || paddle.y - 20,
            dx: baseSpeed * (Math.random() > 0.5 ? 1 : -1),
            dy: -baseSpeed,
            r: 6,
            active: true
        });
    }

    function startGame() {
        score = 0;
        // [ä¿®æ”¹]ï¼šæ ¹æ®éš¾åº¦è®¾ç½®åˆå§‹ç”Ÿå‘½
        lives = DIFFICULTY_SETTINGS[currentDiff].lives;
        level = 1;
        updateUI();
        
        resetPaddle();
        initLevel();
        balls = [];
        powerups = [];
        particles = [];
        spawnBall(); // spawnBall å†…éƒ¨ä¼šè‡ªåŠ¨è¯»å–é€Ÿåº¦é…ç½®
        
        isRunning = true;
        overlay.classList.add('hidden');
        loop();
    }

    function updateUI() {
        document.getElementById('score').innerText = score;
        document.getElementById('lives').innerText = lives;
    }

    // --- æ ¸å¿ƒå¾ªç¯ ---
    function loop() {
        if (!isRunning) return;

        // --- ä¿®æ”¹å¤„ï¼šå¦‚æœæ­£åœ¨æ“ä½œ UIï¼Œåªæ¸²æŸ“ä¸æ›´æ–°é€»è¾‘ï¼ˆæš‚åœï¼‰ ---
        if (theme === 'neon') {
            ctx.fillStyle = 'rgba(5, 5, 5, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // åªæœ‰ä¸åœ¨æ“ä½œ UI æ—¶ï¼Œæ‰æ›´æ–°çƒå’ŒæŒ¡æ¿çš„ä½ç½®
        if (!isInteractingUI) {
            updateLogic();
        }
        
        draw();
        requestAnimationFrame(loop);
    }

    // --- é€»è¾‘æ›´æ–° ---
    function updateLogic() {
        // --- æ–°å¢ï¼šå°„å‡»å†·å´æ§åˆ¶ ---
        // å®šä¹‰ä¸€ä¸ªé™æ€å˜é‡æˆ–å…¨å±€å˜é‡æ¥è®°å½•å†·å´ï¼ˆä¸ºäº†ç®€å•ï¼Œè¿™é‡Œç›´æ¥æŒ‚åœ¨ window ä¸Šæˆ–ä½œä¸ºå…¨å±€å˜é‡ï¼‰
        if (typeof window.laserCooldown === 'undefined') window.laserCooldown = 0;

        if (hasLaser) {
            window.laserCooldown--;
            if (window.laserCooldown <= 0) {
                // å‘å°„å­å¼¹
                lasers.push({x: paddle.x, y: paddle.y});
                lasers.push({x: paddle.x + paddle.w * paddleWidthMult - 5, y: paddle.y});
                window.laserCooldown = 30; // æ¯30å¸§å‘å°„ä¸€æ¬¡ï¼ˆçº¦0.5ç§’ï¼‰
            }
        }

        // ç§»åŠ¨æŒ¡æ¿ (é¼ æ ‡/è§¦æ‘¸)
        // å·²é€šè¿‡äº‹ä»¶ç›‘å¬å™¨æ›´æ–° paddle.x
        
        // é™åˆ¶æŒ¡æ¿èŒƒå›´
        if (paddle.x < 0) paddle.x = 0;
        if (paddle.x + paddle.w * paddleWidthMult > canvas.width) paddle.x = canvas.width - paddle.w * paddleWidthMult;

        // æ¿€å…‰å­å¼¹
        lasers.forEach((l, i) => {
            l.y -= 10;
            if (l.y < 0) lasers.splice(i, 1);
            else {
                // æ¿€å…‰ç¢°æ’ç –å—
                bricks.forEach(b => {
                    if (b.status === 1 && rectIntersect(l.x, l.y, 4, 10, b.x, b.y, b.w, b.h)) {
                        hitBrick(b);
                        lasers.splice(i, 1);
                    }
                });
            }
        });

        // çƒè¿åŠ¨
        for (let i = balls.length - 1; i >= 0; i--) {
            let b = balls[i];
            if (!b.active) continue;

            b.x += b.dx;
            b.y += b.dy;

            // å¢™å£ç¢°æ’
            if (b.x + b.r > canvas.width || b.x - b.r < 0) {
                b.dx *= -1;
                spawnParticles(b.x, b.y, '#fff', 3);
            }
            if (b.y - b.r < 0) {
                b.dy *= -1;
                spawnParticles(b.x, b.y, '#fff', 3);
            }
            // æ‰è½
            if (b.y - b.r > canvas.height) {
                balls.splice(i, 1);
                continue;
            }

            // æŒ¡æ¿ç¢°æ’
            if (circleRectIntersect(b.x, b.y, b.r, paddle.x, paddle.y, paddle.w * paddleWidthMult, paddle.h)) {
                // è®¡ç®—åå¼¹è§’åº¦ï¼šæ ¹æ®å‡»ä¸­æŒ¡æ¿çš„ä½ç½®
                let hitPoint = b.x - (paddle.x + paddle.w * paddleWidthMult / 2);
                // å½’ä¸€åŒ– -1 åˆ° 1
                hitPoint = hitPoint / (paddle.w * paddleWidthMult / 2);
                
                let angle = hitPoint * (Math.PI / 3); 
                let speed = Math.sqrt(b.dx*b.dx + b.dy*b.dy);
                
                // [ä¿®æ”¹]ï¼šæ ¹æ®éš¾åº¦å†³å®šçƒåŠ é€Ÿçš„å¹…åº¦
                // å›°éš¾æ¨¡å¼ä¸‹ï¼Œçƒä¼šè¶Šæ¥è¶Šå¿«ï¼Œæ›´åŠ åˆºæ¿€
                speed = Math.min(speed * DIFFICULTY_SETTINGS[currentDiff].speedInc, 18); 

                b.dx = speed * Math.sin(angle);
                b.dy = -speed * Math.cos(angle);
                b.y = paddle.y - b.r - 1; // é˜²æ­¢ç²˜è¿

                spawnParticles(b.x, b.y, PALETTES[theme].paddle, 5);
            }

            // ç –å—ç¢°æ’
            for (let j = 0; j < bricks.length; j++) {
                let br = bricks[j];
                if (br.status === 1) {
                    if (circleRectIntersect(b.x, b.y, b.r, br.x, br.y, br.w, br.h)) {
                        if (!fireBallActive) {
                            // ç®€å•åå¼¹é€»è¾‘ï¼šåˆ¤æ–­æ˜¯æ’äº†æ¨ªè¾¹è¿˜æ˜¯ç«–è¾¹
                            // (è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥åè½¬ Yï¼Œå¤§éƒ¨åˆ†æƒ…å†µå¤Ÿç”¨)
                            b.dy *= -1; 
                        }
                        hitBrick(br);
                        break; // ä¸€å¸§åªæ’ä¸€å—ï¼Œé˜²æ­¢ç©¿é€
                    }
                }
            }
        }

        // æ£€æŸ¥æ­»çƒ
        if (balls.length === 0) {
            lives--;
            fireBallActive = false;
            paddleWidthMult = 1;
            hasLaser = false;
            updateUI();
            if (lives > 0) {
                spawnBall();
            } else {
                gameOver(false);
            }
        }
        
        // æ£€æŸ¥å…³å¡èƒœåˆ©
        if (bricks.every(b => b.status === 0)) {
            level++;
            fireBallActive = false; // è¿‡å…³é‡ç½®å¼ºåŠ›é“å…·
            initLevel();
            spawnBall();
        }

        // é“å…·ç§»åŠ¨
        for (let i = powerups.length - 1; i >= 0; i--) {
            let p = powerups[i];
            p.y += 3;
            if (p.y > canvas.height) {
                powerups.splice(i, 1);
            } else if (rectIntersect(p.x, p.y, 20, 20, paddle.x, paddle.y, paddle.w * paddleWidthMult, paddle.h)) {
                activatePowerup(p.type);
                powerups.splice(i, 1);
            }
        }

        // ç²’å­
        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].x += particles[i].vx;
            particles[i].y += particles[i].vy;
            particles[i].life -= 0.03;
            if (particles[i].life <= 0) particles.splice(i, 1);
        }
    }

    function hitBrick(brick) {
        brick.status = 0;
        score += brick.val * 10;
        updateUI();
        
        // ç²’å­çˆ†ç‚¸
        spawnParticles(brick.x + brick.w/2, brick.y + brick.h/2, PALETTES[theme].bricks[brick.colorIdx], 8);
        shakeScreen(3);

        // [ä¿®æ”¹]ï¼šæ ¹æ®éš¾åº¦è®¾ç½®é“å…·æ‰è½ç‡
        if (Math.random() < DIFFICULTY_SETTINGS[currentDiff].dropRate) {
            const types = ['multi', 'wide', 'fire', 'laser'];
            const type = types[Math.floor(Math.random() * types.length)];
            powerups.push({ x: brick.x + brick.w/2, y: brick.y, type: type });
        }
    }

    function activatePowerup(type) {
        if (type === 'multi') {
            // [ä¼˜åŒ–]ï¼šè®¾ç½®æœ€å¤§çƒæ•°é‡é™åˆ¶ (ä¾‹å¦‚ 50 ä¸ª)
            if (balls.length > 50) return; 

            // åˆ†è£‚æ‰€æœ‰çƒ
            let len = balls.length;
            for(let i=0; i<len; i++) {
                // å†æ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢ç¬é—´çˆ†ç‚¸
                if (balls.length > 50) break;
                spawnBall(balls[i].x, balls[i].y, 6);
            }
        } else if (type === 'wide') {
            paddleWidthMult = 1.5;
            setTimeout(() => paddleWidthMult = 1, 10000); // 10ç§’åæ¢å¤
        } else if (type === 'fire') {
            fireBallActive = true;
            setTimeout(() => fireBallActive = false, 8000);
        } else if (type === 'laser') {
            hasLaser = true;
            // 20å‘å­å¼¹æˆ–é™æ—¶
            setTimeout(() => hasLaser = false, 8000);
        }
    }

    // --- ç»˜åˆ¶ ---
    function draw() {
        // ç”»ç –å—
        bricks.forEach(b => {
            if (b.status === 1) {
                const color = PALETTES[theme].bricks[b.colorIdx];
                ctx.fillStyle = color;
                
                if (theme === 'candy') {
                    roundRect(ctx, b.x, b.y, b.w, b.h, 5, true, false);
                } else if (theme === 'retro') {
                    ctx.fillRect(b.x + 2, b.y + 2, b.w - 4, b.h - 4);
                    ctx.strokeStyle = color; ctx.lineWidth = 2;
                    ctx.strokeRect(b.x + 2, b.y + 2, b.w - 4, b.h - 4);
                } else { // Neon
                    ctx.shadowBlur = 10; ctx.shadowColor = color;
                    ctx.fillRect(b.x, b.y, b.w, b.h);
                    ctx.shadowBlur = 0;
                }
            }
        });

        // ç”»æŒ¡æ¿
        const pColor = PALETTES[theme].paddle;
        ctx.fillStyle = pColor;
        const pw = paddle.w * paddleWidthMult;
        if (theme === 'candy') {
            roundRect(ctx, paddle.x, paddle.y, pw, paddle.h, 8, true, false);
        } else if (theme === 'neon') {
            ctx.shadowBlur = 15; ctx.shadowColor = pColor;
            ctx.fillRect(paddle.x, paddle.y, pw, paddle.h);
            ctx.shadowBlur = 0;
        } else {
            ctx.fillRect(paddle.x, paddle.y, pw, paddle.h);
        }
        
        // ç”»æ¿€å…‰ç‚®å°
        if (hasLaser) {
            ctx.fillStyle = pColor;
            ctx.fillRect(paddle.x, paddle.y - 10, 5, 10);
            ctx.fillRect(paddle.x + pw - 5, paddle.y - 10, 5, 10);
        }

        // ç”»çƒ
        // ç”»çƒ
        // [ä¼˜åŒ–]ï¼šå¦‚æœçƒçš„æ•°é‡è¶…è¿‡ 10 ä¸ªï¼Œä¸ºäº†ä¿æµç•…ï¼Œå…³é—­ Neon æ¨¡å¼çš„é˜´å½±
        const enableShadows = theme === 'neon' && balls.length < 10;

        balls.forEach(b => {
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
            ctx.fillStyle = fireBallActive ? '#ff4d4d' : PALETTES[theme].ball;
            
            if (enableShadows) {
                ctx.shadowBlur = 10; 
                ctx.shadowColor = ctx.fillStyle;
            }
            
            ctx.fill();
            
            if (enableShadows) {
                ctx.shadowBlur = 0;
            }
            
            if (fireBallActive) {
                // [ä¼˜åŒ–]ï¼šç«çƒæ‹–å°¾åªæœ‰åœ¨ç²’å­æ•°ä¸å¤šæ—¶æ‰ç”Ÿæˆ
                if (particles.length < 100) {
                    spawnParticles(b.x, b.y, '#ff4d4d', 1);
                }
            }
        });

        // ç”»é“å…·
        powerups.forEach(p => {
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(p.x, p.y, 10, 0, Math.PI*2);
            ctx.fill();
            // å›¾æ ‡
            ctx.fillStyle = '#000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            let icon = p.type === 'multi' ? 'M' : p.type === 'wide' ? 'W' : p.type === 'fire' ? 'F' : 'L';
            ctx.fillText(icon, p.x, p.y + 4);
        });

        // ç”»æ¿€å…‰
        ctx.fillStyle = '#f00';
        lasers.forEach(l => ctx.fillRect(l.x, l.y, 4, 10));

        // ç”»ç²’å­
        particles.forEach(p => {
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, p.size, p.size);
        });
        ctx.globalAlpha = 1;

        if (isInteractingUI && isRunning) {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 30px Arial';
        ctx.textAlign = 'center';
        ctx.fillText("GAME PAUSED", canvas.width / 2, canvas.height / 2);
        ctx.font = '16px Arial';
        ctx.fillText("Select a theme...", canvas.width / 2, canvas.height / 2 + 30);
    }
    }

    // --- è¾…åŠ©å‡½æ•° ---
    function spawnParticles(x, y, color, count) {
        // [ä¼˜åŒ–]ï¼šå¦‚æœç²’å­æ€»æ•°è¶…è¿‡ 150ï¼Œå°±ä¸å†ç”Ÿæˆæ–°ç²’å­ï¼Œæˆ–è€…ç§»é™¤æ—§çš„
        if (particles.length > 150) {
            // ç§»é™¤æœ€æ—©ç”Ÿæˆçš„ count ä¸ªç²’å­ï¼Œä¿æŒæ•°ç»„ç²¾ç®€
            particles.splice(0, count); 
        }

        for(let i=0; i<count; i++) {
            // [ä¼˜åŒ–]ï¼šå‡å°‘ç²’å­å¯¿å‘½ï¼Œè®©å®ƒä»¬æ¶ˆå¤±å¾—æ›´å¿« (life ä» 1.0 å‡åˆ° 0.03 éœ€è¦ 33å¸§)
            // æˆ‘ä»¬å¯ä»¥ç¨å¾®å¢åŠ å‡å°‘çš„é€Ÿåº¦
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 5,
                vy: (Math.random() - 0.5) * 5,
                life: 1.0,
                color: color,
                size: Math.random() * 3 + 2
            });
        }
    }

    function shakeScreen(power) {
        // ç®€å•çš„ç”»å¸ƒåç§»éœ‡åŠ¨
        const canvasEl = document.getElementById('gameCanvas');
        canvasEl.style.transform = `translate(${Math.random()*power-power/2}px, ${Math.random()*power-power/2}px)`;
        setTimeout(() => canvasEl.style.transform = 'none', 50);
    }

    function circleRectIntersect(cx, cy, cr, rx, ry, rw, rh) {
        let testX = cx;
        let testY = cy;
        if (cx < rx) testX = rx;
        else if (cx > rx + rw) testX = rx + rw;
        if (cy < ry) testY = ry;
        else if (cy > ry + rh) testY = ry + rh;
        let distX = cx - testX;
        let distY = cy - testY;
        return (distX*distX + distY*distY) <= (cr*cr);
    }

    function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
        return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
    }

    function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
        if (typeof stroke === 'undefined') stroke = true;
        if (typeof radius === 'undefined') radius = 5;
        if (typeof radius === 'number') radius = {tl: radius, tr: radius, br: radius, bl: radius};
        ctx.beginPath();
        ctx.moveTo(x + radius.tl, y);
        ctx.lineTo(x + width - radius.tr, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
        ctx.lineTo(x + width, y + height - radius.br);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
        ctx.lineTo(x + radius.bl, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
        ctx.lineTo(x, y + radius.tl);
        ctx.quadraticCurveTo(x, y, x + radius.tl, y);
        ctx.closePath();
        if (fill) ctx.fill();
        if (stroke) ctx.stroke();
    }

    function gameOver(win) {
        isRunning = false;
        overlay.classList.remove('hidden');
        titleText.innerText = win ? "YOU WIN" : "GAME OVER";
        btnStart.innerText = "RESTART";
    }

    // --- è¾“å…¥æ§åˆ¶ (å‡çº§ç‰ˆ) ---

    // 1. é¼ æ ‡ç§»åŠ¨é€»è¾‘ä¼˜åŒ–
    document.addEventListener('mousemove', (e) => {
        // å¦‚æœæ¸¸æˆæ²¡å¼€å§‹ï¼Œæˆ–è€…æ­£åœ¨æ“ä½œUIï¼Œæˆ–è€…æ¸¸æˆç»“æŸï¼Œä¸ç§»åŠ¨æŒ¡æ¿
        if (!isRunning || isInteractingUI) return;

        const rect = canvas.getBoundingClientRect();
        
        // ğŸ”’ å®‰å…¨åŒºæ£€æŸ¥ï¼šåªæœ‰å½“é¼ æ ‡åœ¨ Canvas å†…éƒ¨æˆ–ä¸‹æ–¹æ—¶æ‰æ§åˆ¶æŒ¡æ¿
        // å¦‚æœé¼ æ ‡ç§»åˆ°äº† Canvas ä¸Šæ–¹ï¼ˆå»ç‚¹æŒ‰é’®äº†ï¼‰ï¼Œåˆ™å¿½ç•¥ç§»åŠ¨
        if (e.clientY < rect.top) return;

        const rootX = e.clientX - rect.left;
        const scaleX = canvas.width / rect.width;
        
        paddle.x = rootX * scaleX - (paddle.w * paddleWidthMult / 2);
    });

    // 2. UI å®¹å™¨çš„äº¤äº’ç›‘å¬ (è‡ªåŠ¨æš‚åœ)
    const uiContainer = document.getElementById('ui-container');
    
    uiContainer.addEventListener('mouseenter', () => {
        if (isRunning) isInteractingUI = true;
    });
    
    uiContainer.addEventListener('mouseleave', () => {
        isInteractingUI = false;
    });
    
    // é˜²æ­¢åœ¨ UI ä¸Šç‚¹å‡»è§¦å‘ Canvas çš„æ„å¤–è¡Œä¸º
    uiContainer.addEventListener('mousedown', (e) => e.stopPropagation());


    // 3. è§¦æ‘¸æ”¯æŒ (ä¿æŒä¸å˜)
    document.addEventListener('touchmove', (e) => {
        if (isInteractingUI) return; // å¦‚æœæ‰‹æŒ‡åœ¨ UI ä¸Šï¼Œä¸åŠ¨æŒ¡æ¿
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const rootX = e.touches[0].clientX - rect.left;
        const scaleX = canvas.width / rect.width;
        paddle.x = rootX * scaleX - (paddle.w * paddleWidthMult / 2);
    }, {passive: false});

    // 4. é”®ç›˜æ”¯æŒ (æ–°å¢å¿«æ·é”®)
    document.addEventListener('keydown', (e) => {
        // æ¿€å…‰å°„å‡»
        if (e.code === 'Space' && hasLaser) {
            lasers.push({x: paddle.x, y: paddle.y});
            lasers.push({x: paddle.x + paddle.w * paddleWidthMult, y: paddle.y});
        }
        
        // ä¸»é¢˜å¿«æ·é”® (1, 2, 3)
        if (e.key === '1') manualSetTheme('neon');
        if (e.key === '2') manualSetTheme('candy');
        if (e.key === '3') manualSetTheme('retro');
    });
    
    // è¾…åŠ©å‡½æ•°ï¼šæ‰‹åŠ¨è§¦å‘ä¸»é¢˜åˆ‡æ¢ï¼ˆæ¨¡æ‹Ÿç‚¹å‡»æŒ‰é’®çš„æ•ˆæœï¼‰
    function manualSetTheme(name) {
        // æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®å¹¶æ¨¡æ‹Ÿç‚¹å‡»é€»è¾‘
        const btns = document.querySelectorAll('.theme-btn');
        btns.forEach(btn => {
            if (btn.textContent.toLowerCase() === name) {
                // è°ƒç”¨ç°æœ‰çš„ setTheme
                // æ„é€ ä¸€ä¸ªä¼ªé€ çš„ event å¯¹è±¡ï¼Œå› ä¸º setTheme ä¾èµ– event.target
                const mockEvent = { target: btn };
                // ä¸´æ—¶æ›¿æ¢å…¨å±€ event (æˆ–è€…ä¿®æ”¹ setTheme å‡½æ•°ä¸ä¾èµ– event)
                // è¿™é‡Œä¸ºäº†ä¸æ”¹åŠ¨ä¸Šé¢ä»£ç ï¼Œå»ºè®®æ‚¨å¾®è°ƒä¸€ä¸‹ä¸Šé¢çš„ setTheme å‡½æ•°:
                // å°† `event.target.classList.add` æ”¹ä¸ºé€šè¿‡é€‰æ‹©å™¨æŸ¥æ‰¾
            }
        });
        // å…¶å®æœ€ç®€å•çš„æ˜¯ç›´æ¥è°ƒç”¨é€»è¾‘ï¼š
        setTheme(name);
        // æ‰‹åŠ¨æ›´æ–°æŒ‰é’®æ ·å¼
        document.querySelectorAll('.theme-btn').forEach(b => {
            b.classList.remove('active');
            if(b.textContent.toLowerCase() === name) b.classList.add('active');
        });
    }

    // è‡ªåŠ¨å°„å‡»
    // setInterval(() => {
    //     if (isRunning && !isInteractingUI && hasLaser) {
    //         lasers.push({x: paddle.x, y: paddle.y});
    //         lasers.push({x: paddle.x + paddle.w * paddleWidthMult - 5, y: paddle.y});
    //     }
    // }, 500);

</script>
</body>
</html>
